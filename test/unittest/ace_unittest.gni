# Copyright (c) 2023 Huawei Device Co., Ltd.
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#     http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

import("//build/ohos.gni")
import("//build/test.gni")
import("//foundation/arkui/ace_engine/ace_config.gni")

pattern_test_output_path = "ace_engine/components"
gestures_test_output_path = "ace_engine/gestures"
event_test_output_path = "ace_engine/evnets"
base_test_output_path = "ace_engine/base"
syntax_test_output_path = "ace_engine/syntaxs"
image_test_output_path = "ace_engine/image"
basic_test_output_path = "ace_engine/basic"
manager_test_output_path = "ace_engine/manager"
interface_test_output_path = "ace_engine/interfaces"
accessibility_test_output_path = "ace_engine/accessibility"
property_test_output_path = "ace_engine/property"
layout_test_output_path = "ace_engine/layout"
svg_test_output_path = "ace_engine/svg"
render_test_output_path = "ace_engine/render"

test_pattern_sources = [
  # base
  "$ace_root/frameworks/base/geometry/dimension.cpp",
  "$ace_root/frameworks/base/json/json_util.cpp",
  "$ace_root/frameworks/base/utils/base_id.cpp",
  "$ace_root/frameworks/base/utils/string_expression.cpp",
  "$ace_root/frameworks/base/utils/string_utils.cpp",

  # components
  "$ace_root/frameworks/core/components/common/layout/grid_column_info.cpp",
  "$ace_root/frameworks/core/components/common/layout/grid_container_info.cpp",
  "$ace_root/frameworks/core/components/common/layout/grid_system_manager.cpp",
  "$ace_root/frameworks/core/components/common/layout/screen_system_manager.cpp",
  "$ace_root/frameworks/core/components/common/properties/alignment.cpp",
  "$ace_root/frameworks/core/components/common/properties/color.cpp",

  # components_ng
  "$ace_root/frameworks/core/components_ng/base/frame_node.cpp",
  "$ace_root/frameworks/core/components_ng/base/geometry_node.cpp",
  "$ace_root/frameworks/core/components_ng/base/ui_node.cpp",
  "$ace_root/frameworks/core/components_ng/base/view_stack_processor.cpp",
  "$ace_root/frameworks/core/components_ng/event/click_event.cpp",
  "$ace_root/frameworks/core/components_ng/event/drag_event.cpp",
  "$ace_root/frameworks/core/components_ng/event/event_hub.cpp",
  "$ace_root/frameworks/core/components_ng/event/focus_hub.cpp",
  "$ace_root/frameworks/core/components_ng/event/gesture_event_hub.cpp",
  "$ace_root/frameworks/core/components_ng/event/input_event.cpp",
  "$ace_root/frameworks/core/components_ng/event/input_event_hub.cpp",
  "$ace_root/frameworks/core/components_ng/event/pan_event.cpp",
  "$ace_root/frameworks/core/components_ng/event/state_style_manager.cpp",
  "$ace_root/frameworks/core/components_ng/event/touch_event.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/gesture_referee.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/click_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/exclusive_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/gesture_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/long_press_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/multi_fingers_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/pan_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/parallel_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/recognizer_group.cpp",
  "$ace_root/frameworks/core/components_ng/gestures/recognizers/sequenced_recognizer.cpp",
  "$ace_root/frameworks/core/components_ng/layout/box_layout_algorithm.cpp",
  "$ace_root/frameworks/core/components_ng/layout/layout_property.cpp",
  "$ace_root/frameworks/core/components_ng/layout/layout_wrapper.cpp",
  "$ace_root/frameworks/core/components_ng/layout/layout_wrapper_builder.cpp",
  "$ace_root/frameworks/core/components_ng/property/calc_length.cpp",
  "$ace_root/frameworks/core/components_ng/property/grid_property.cpp",
  "$ace_root/frameworks/core/components_ng/property/measure_utils.cpp",
  "$ace_root/frameworks/core/components_ng/property/property.cpp",
  "$ace_root/frameworks/core/components_ng/render/drawing_prop_convertor.cpp",
  "$ace_root/frameworks/core/components_ng/render/paint_wrapper.cpp",

  # components_v2
  "$ace_root/frameworks/core/components_v2/inspector/inspector_constants.cpp",

  # pipeline
  "$ace_root/frameworks/core/pipeline/base/constants.cpp",

  # mock
  "$ace_root/frameworks/base/test/mock/mock_ressched_report.cpp",
  "$ace_root/frameworks/base/test/mock/mock_system_properties.cpp",
  "$ace_root/frameworks/core/common/test/mock/mock_ace_application_info.cpp",
  "$ace_root/frameworks/core/components/test/unittest/mock/ace_trace_mock.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/animation/mock_geometry_transition.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/base/mock_localization.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/pattern/grid_container/mock_grid_container_layout_property.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/render/mock_animation_utils.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/render/mock_modifier_adapter.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/render/mock_render_context.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/render/mock_render_context_creator.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/render/mock_render_surface_creator.cpp",
  "$ace_root/frameworks/core/components_ng/test/mock/syntax/mock_for_each_node.cpp",
  "$ace_root/frameworks/core/pipeline_ng/test/mock/mock_element_register.cpp",
  "$ace_root/frameworks/core/pipeline_ng/test/mock/mock_pipeline_base.cpp",
]

template("ace_unittest") {
  forward_variables_from(invoker, "*")

  type = "components"
  ace_animation = false
  flutter_skia = false
  ace_unittest_out_path = "ace_engine/$type"
  ace_unittest_name = target_name
  ace_unittest_config = [ "$ace_root/test/unittest:ace_unittest_config" ]
  flutter_sources = []
  ace_unittest_deps = [
    "$ace_root/frameworks/base:ace_memory_monitor_ohos",
    "$ace_root/test/unittest:ace_unittest_log",
    "$ace_root/test/unittest:ace_unittest_trace",
    "//third_party/googletest:gmock_main",
  ]

  ace_mock_sources = [
    "$ace_root/frameworks/base/test/mock/mock_drag_window.cpp",
    "$ace_root/frameworks/base/test/mock/mock_ressched_report.cpp",
    "$ace_root/frameworks/base/test/mock/mock_system_properties.cpp",
    "$ace_root/frameworks/core/common/test/mock/mock_ace_application_info.cpp",
    "$ace_root/frameworks/core/components_ng/test/event/scrollable_event/mock_scrollable.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/base/mock_localization.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/image_provider/mock_image_cache.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/image_provider/mock_image_loading_context.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/image_provider/mock_image_source_info.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/render/mock_animation_utils.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/render/mock_modifier_adapter.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/render/mock_render_context_creator.cpp",
    "$ace_root/frameworks/core/components_ng/test/mock/render/mock_render_surface_creator.cpp",
    "$ace_root/frameworks/core/components_ng/test/pattern/text/mock/mock_text_layout_adapter.cpp",
    "$ace_root/frameworks/core/pipeline_ng/test/mock/mock_element_register.cpp",
    "$ace_root/frameworks/core/pipeline_ng/test/mock/mock_pipeline_base.cpp",
    "$ace_root/test/mock/core/common/mock_container.cpp",
    "$ace_root/test/mock/core/render/mock_font_collection.cpp",
    "$ace_root/test/mock/core/render/mock_paragraph.cpp",
  ]

  if (defined(invoker.ace_log)) {
    ace_log = invoker.ace_log
  }

  if (defined(invoker.type)) {
    type = invoker.type
    ace_unittest_out_path = "ace_engine/$type"
  }

  if (defined(invoker.ace_animation)) {
    ace_animation = invoker.ace_animation
  }

  if (ace_animation) {
    ace_unittest_deps += [ "$ace_root/test/unittest:ace_core_animation" ]
  }

  if (defined(invoker.flutter_skia)) {
    flutter_skia = invoker.flutter_skia
  }

  if (flutter_skia) {
    if (ace_use_new_skia) {
      flutter_sources += [
        "$flutter_root/engine/flutter/runtime/window_manager.cc",
        "$flutter_root/engine/flutter/shell/platform/ohos/platform_task_runner.cc",
        "$flutter_root/engine/flutter/shell/platform/ohos/platform_task_runner_adapter.cc",
      ]
      ace_unittest_deps += [
        "$ace_flutter_engine_root:flutter_engine_common_ohos",
        "$ace_flutter_engine_root:flutter_engine_fml_ohos",
        "$ace_flutter_engine_root/libtxt:thirdparty_lib_txt_ohos",
        "$skia_root_new:skia_ohos",
      ]
      ace_unittest_config += [ "$ace_flutter_engine_root:flutter_config" ]
    } else {
      ace_unittest_deps += [
        "$ace_flutter_engine_root:third_party_flutter_engine_ohos",
        "$ace_flutter_engine_root/skia:ace_skia_ohos",
      ]
    }
  }

  if (defined(invoker.extra_deps)) {
    ace_unittest_deps += invoker.extra_deps
  }

  if (type == "components") {
    ohos_unittest(ace_unittest_name) {
      module_out_path = ace_unittest_out_path
      sources = []
      sources += invoker.sources
      sources += ace_mock_sources
      sources += flutter_sources
      deps = ace_unittest_deps
      deps += [
        "$ace_root/frameworks/core/components/theme:build_theme_code",
        "$ace_root/test/unittest:ace_base",
        "$ace_root/test/unittest:ace_components_base",
        "$ace_root/test/unittest:ace_components_event",
        "$ace_root/test/unittest:ace_components_extra",
        "$ace_root/test/unittest:ace_components_gestures",
        "$ace_root/test/unittest:ace_components_layout",
        "$ace_root/test/unittest:ace_components_property",
        "$ace_root/test/unittest:ace_components_render",
        "$ace_root/test/unittest:ace_components_syntax",
      ]

      configs = ace_unittest_config

      if (defined(invoker.configs)) {
        configs += invoker.configs
      }

      if (defined(invoker.external_deps)) {
        external_deps = []
        external_deps += invoker.external_deps
      }
    }
  } else if (type == "events") {
  } else if (type == "gestures") {
  } else if (type == "base") {
  } else if (type == "basic") {
  } else if (type == "syntax") {
  } else if (type == "image") {
  } else if (type == "manager") {
  } else if (type == "interface") {
  } else if (type == "accessibility") {
  } else if (type == "layout") {
  } else if (type == "svg") {
  } else {
    assert(false)
  }
}
